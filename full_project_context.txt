
==================================================
FILE: .\manage.py
==================================================
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()


==================================================
FILE: .\config\asgi.py
==================================================
"""
ASGI config for config project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/6.0/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_asgi_application()


==================================================
FILE: .\config\settings.py
==================================================
"""
Django settings for config project.

Generated by 'django-admin startproject' using Django 6.0.

For more information on this file, see
https://docs.djangoproject.com/en/6.0/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/6.0/ref/settings/
"""

from pathlib import Path

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/6.0/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-=nis9s302+$)c=thg=17=fi3-%ym+93)_x1!61q9dmb$5$=usl'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []

# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    # --- APP CỦA BẠN (Thêm vào đây) ---
    'rest_framework',
    'simple_history',    
    'warehouse_input',
    'warehouse_stock',
    'production.apps.ProductionConfig', # Khai báo đầy đủ để chạy được Signals

    
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'config.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'config.wsgi.application'


# Database
# https://docs.djangoproject.com/en/6.0/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}


# Password validation
# https://docs.djangoproject.com/en/6.0/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/6.0/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/6.0/howto/static-files/

STATIC_URL = 'static/'
import os

# Đường dẫn URL để truy cập file trên trình duyệt
MEDIA_URL = '/media/'

# Thư mục vật lý trên ổ cứng để chứa file
MEDIA_ROOT = BASE_DIR / 'media'

==================================================
FILE: .\config\urls.py
==================================================
from django.contrib import admin
from django.urls import path, include
from rest_framework.routers import DefaultRouter

# 1. IMPORT TỪ APP KHO (WAREHOUSE)
from warehouse_input.views import (
    MaterialTypeViewSet, 
    SupplierViewSet, 
    InputVoucherViewSet, 
    import_page
)
from warehouse_stock.views import (
    InventoryItemViewSet, 
    StockAdjustmentViewSet, 
    inventory_page
)

# 2. IMPORT TỪ APP SẢN XUẤT (PRODUCTION) - CẦN CẬP NHẬT ĐỦ Ở ĐÂY
from production.views import (
    ProductionOrderViewSet,      # <--- Cái bạn đang thiếu
    ProductionBatchViewSet,
    MaterialIssueDetailViewSet,  # <--- Cái mới thêm
    WeighingSlipViewSet,
    FinishedBundleViewSet,
    CustomerViewSet,
    ProductStandardViewSet,
    index, 
    weighing
)

router = DefaultRouter()

# --- ROUTER KHO ---
router.register(r'materials', MaterialTypeViewSet)
router.register(r'suppliers', SupplierViewSet)
router.register(r'input-vouchers', InputVoucherViewSet)
router.register(r'inventory', InventoryItemViewSet)
router.register(r'adjustments', StockAdjustmentViewSet)

# --- ROUTER SẢN XUẤT (MỚI) ---
router.register(r'production-orders', ProductionOrderViewSet)
router.register(r'batches', ProductionBatchViewSet)
router.register(r'material-issues', MaterialIssueDetailViewSet)
router.register(r'weighing-slips', WeighingSlipViewSet)
router.register(r'finished-bundles', FinishedBundleViewSet)
router.register(r'customers', CustomerViewSet)
router.register(r'standards', ProductStandardViewSet)

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/', include(router.urls)),
    
    # Các trang HTML
    path('', index, name='home'),
    path('can-hang/', weighing, name='weighing'),
    path('ton-kho/', inventory_page, name='inventory'),
    path('nhap-kho/', import_page, name='import'),
]

==================================================
FILE: .\config\wsgi.py
==================================================
"""
WSGI config for config project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/6.0/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_wsgi_application()


==================================================
FILE: .\config\__init__.py
==================================================


==================================================
FILE: .\production\admin.py
==================================================
from django.contrib import admin
from .models import (
    Customer, AlloyType, ProductStandard, 
    MonthlyPlan, ProductionOrder, ProductionOrderItem, MaterialIssueDetail, 
    ProductionBatch, FurnaceLog, 
    WeighingSlip, FinishedBundle, ScrapReturn,
    DeliveryNote, RepackingSession
)

# ========================================================
# 1. KẾ HOẠCH & ĐƠN HÀNG (TRUNG TÂM)
# ========================================================

class AlloyTypeAdmin(admin.ModelAdmin):
    list_display = ('name', 'description')
    search_fields = ('name',)

class ProductStandardAdmin(admin.ModelAdmin):
    list_display = ('code', 'alloy_type', 'customer', 'si_min', 'si_max', 'fe_max')
    list_filter = ('alloy_type', 'customer')

class ProductionOrderItemInline(admin.TabularInline):
    model = ProductionOrderItem
    extra = 1

class MaterialIssueDetailInline(admin.TabularInline):
    model = MaterialIssueDetail
    fields = ('source_input', 'real_weight', 'status')
    readonly_fields = ('created_at',)
    extra = 0
    can_delete = False

class ProductionOrderAdmin(admin.ModelAdmin):
    list_display = ('lot_no', 'product_type', 'target_quantity', 'customer', 'status', 'date_created')
    # Sửa lỗi: Dùng product_type thay vì product_name
    list_filter = ('status', 'customer', 'product_type') 
    search_fields = ('lot_no', 'customer__name')
    inlines = [ProductionOrderItemInline, MaterialIssueDetailInline]

# ========================================================
# 2. KHO (SOẠN HÀNG)
# ========================================================

class MaterialIssueDetailAdmin(admin.ModelAdmin):
    list_display = ('production_order', 'source_input', 'real_weight', 'status', 'created_at')
    
    # --- ĐÂY LÀ CHỖ GÂY LỖI TRƯỚC ĐÓ ---
    # Đã sửa: production_order__product_name -> production_order__product_type
    list_filter = ('status', 'production_order__product_type') 
    
    search_fields = ('production_order__lot_no',) 

# ========================================================
# 3. LÒ & SẢN XUẤT
# ========================================================

class FurnaceLogInline(admin.TabularInline):
    model = FurnaceLog
    extra = 1
    fields = ('timestamp', 'action_type', 'issue_detail', 'adhoc_material', 'adhoc_weight', 'temperature', 'test_result_note')

class ProductionBatchAdmin(admin.ModelAdmin):
    list_display = ('get_lot_no', 'furnace_name', 'status', 'start_time') 
    list_filter = ('status', 'furnace_name')
    search_fields = ('production_order__lot_no',) 
    inlines = [FurnaceLogInline]

    def get_lot_no(self, obj):
        return obj.production_order.lot_no if obj.production_order else "-"
    get_lot_no.short_description = 'Lot No'

# ========================================================
# 4. THÀNH PHẨM (ĐẦU RA)
# ========================================================

class FinishedBundleInline(admin.TabularInline):
    model = FinishedBundle
    extra = 1

class ScrapReturnInline(admin.TabularInline):
    model = ScrapReturn
    extra = 1

class WeighingSlipAdmin(admin.ModelAdmin):
    list_display = ('code', 'production_order', 'date', 'total_weight_display')
    search_fields = ('code', 'production_order__lot_no')
    inlines = [FinishedBundleInline, ScrapReturnInline]

    def total_weight_display(self, obj):
        total = sum([b.weight for b in obj.bundles.all()])
        return f"{total} kg"
    total_weight_display.short_description = "Tổng KL"

# ========================================================
# 5. CÁC DANH MỤC KHÁC
# ========================================================

class MonthlyPlanAdmin(admin.ModelAdmin):
    list_display = ('month', 'material_type', 'planned_quantity')
    list_filter = ('month',)

# ĐĂNG KÝ
admin.site.register(Customer)
admin.site.register(AlloyType, AlloyTypeAdmin)
admin.site.register(ProductStandard, ProductStandardAdmin)
admin.site.register(MonthlyPlan, MonthlyPlanAdmin)
admin.site.register(ProductionOrder, ProductionOrderAdmin)
admin.site.register(MaterialIssueDetail, MaterialIssueDetailAdmin)
admin.site.register(ProductionBatch, ProductionBatchAdmin)
admin.site.register(WeighingSlip, WeighingSlipAdmin)
admin.site.register(FinishedBundle)
admin.site.register(ScrapReturn)
admin.site.register(DeliveryNote)
admin.site.register(RepackingSession)

==================================================
FILE: .\production\apps.py
==================================================
from django.apps import AppConfig

class ProductionConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'production'

    def ready(self):
        import production.signals

==================================================
FILE: .\production\models.py
==================================================
from django.db import models
from django.utils import timezone
from simple_history.models import HistoricalRecords
from warehouse_input.models import InputVoucherDetail, MaterialType

# ==============================================================================
# 1. DANH MỤC CƠ BẢN (KHÁCH HÀNG, MÁC NHÔM, TIÊU CHUẨN)
# ==============================================================================

class Customer(models.Model):
    code = models.CharField(max_length=20, unique=True, verbose_name="Mã KH")
    name = models.CharField(max_length=200, verbose_name="Tên Khách Hàng")
    def __str__(self): return self.name

class AlloyType(models.Model):
    """
    DANH MỤC MÁC NHÔM (MASTER DATA)
    VD: ADC12, A356, 6063...
    """
    name = models.CharField(max_length=50, unique=True, verbose_name="Tên Mác Nhôm")
    description = models.TextField(blank=True, verbose_name="Mô tả đặc tính")

    def __str__(self): return self.name

class ProductStandard(models.Model):
    """
    Tiêu chuẩn sản phẩm theo từng Khách hàng & Mác nhôm
    """
    code = models.CharField(max_length=50, unique=True, verbose_name="Mã Tiêu chuẩn")
    customer = models.ForeignKey(Customer, on_delete=models.CASCADE, verbose_name="Khách hàng")
    
    # --- THAY ĐỔI: Chọn từ danh sách Mác nhôm ---
    alloy_type = models.ForeignKey(AlloyType, on_delete=models.PROTECT, verbose_name="Mác nhôm áp dụng")
    
    # Thành phần hóa học yêu cầu
    si_min = models.FloatField(default=0, verbose_name="Si Min")
    si_max = models.FloatField(default=0, verbose_name="Si Max")
    fe_min = models.FloatField(default=0, verbose_name="Fe Min")
    fe_max = models.FloatField(default=0, verbose_name="Fe Max")
    cu_min = models.FloatField(default=0, verbose_name="Cu Min")
    cu_max = models.FloatField(default=0, verbose_name="Cu Max")
    # ... Bạn có thể thêm Mg, Mn, Zn, Ni ...
    
    notes = models.TextField(blank=True, verbose_name="Quy cách tem/đóng gói")

    class Meta:
        unique_together = ('customer', 'alloy_type') # Mỗi KH chỉ có 1 tiêu chuẩn cho 1 loại mác nhôm

    def __str__(self): return f"{self.alloy_type.name} - {self.customer.code}"


# ==============================================================================
# 2. KẾ HOẠCH & LỆNH SẢN XUẤT (TRUNG TÂM LOTNO)
# ==============================================================================

class MonthlyPlan(models.Model):
    month = models.CharField(max_length=7, verbose_name="Tháng (YYYY-MM)") 
    material_type = models.ForeignKey(MaterialType, on_delete=models.CASCADE, verbose_name="Loại vật tư")
    planned_quantity = models.FloatField(default=0, verbose_name="Kế hoạch (Kg)")
    
    class Meta:
        unique_together = ('month', 'material_type')

    def __str__(self): return f"Plan {self.month} - {self.material_type.name}"

class ProductionOrder(models.Model):
    """
    Lệnh Sản Xuất
    """
    lot_no = models.CharField(max_length=50, unique=True, verbose_name="LOT NO (Mã Lô)") 
    customer = models.ForeignKey(Customer, on_delete=models.PROTECT, verbose_name="Khách hàng")
    
    # --- THAY ĐỔI: Chọn Mác nhôm từ danh sách ---
    product_type = models.ForeignKey(AlloyType, on_delete=models.PROTECT, verbose_name="Sản phẩm (Mác nhôm)")
    
    # Tiêu chuẩn sẽ tự động link theo KH + Mác nhôm (hoặc chọn thủ công nếu muốn override)
    standard = models.ForeignKey(ProductStandard, on_delete=models.SET_NULL, null=True, blank=True, verbose_name="Tiêu chuẩn áp dụng")
    
    target_quantity = models.FloatField(default=0, verbose_name="Sản lượng yêu cầu (Kg)")
    date_created = models.DateTimeField(default=timezone.now, verbose_name="Ngày lập lệnh")
    
    status = models.CharField(max_length=20, choices=[
        ('NEW', 'Mới tạo'), 
        ('PROCESSING', 'Đang sản xuất'), 
        ('DONE', 'Đã đóng Lô')
    ], default='NEW')
    
    note = models.TextField(blank=True, verbose_name="Ghi chú SX")

    def __str__(self): return f"{self.lot_no} ({self.product_type.name})"

class ProductionOrderItem(models.Model):
    production_order = models.ForeignKey(ProductionOrder, related_name='items', on_delete=models.CASCADE)
    material_type = models.ForeignKey(MaterialType, on_delete=models.PROTECT, verbose_name="Loại liệu cần")
    quantity_required = models.FloatField(verbose_name="Khối lượng cần (Kg)")
    
    def __str__(self): return f"{self.production_order.lot_no} - {self.material_type.name}"


# ==============================================================================
# 3. KHO: PHIẾU CÂN / SOẠN HÀNG (LIÊN KẾT VỚI LOTNO)
# ==============================================================================

class MaterialIssueDetail(models.Model):
    production_order = models.ForeignKey(ProductionOrder, on_delete=models.CASCADE, related_name='material_issues', verbose_name="Thuộc LotNo")
    source_input = models.ForeignKey(InputVoucherDetail, on_delete=models.PROTECT, verbose_name="Lấy từ Lô Nhập")
    real_weight = models.DecimalField(max_digits=10, decimal_places=2, verbose_name="KL Thực (Kg)")
    
    status = models.CharField(max_length=20, choices=[
        ('WAITING', 'Đã cân/Chờ lò'), 
        ('CHARGED', 'Đã nạp lò'),
        ('RETURN', 'Trả lại kho')
    ], default='WAITING')
    
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self): return f"Lot {self.production_order.lot_no} - {self.real_weight}kg"


# ==============================================================================
# 4. LÒ: NHẬT KÝ SẢN XUẤT (GẮN VỚI LOTNO)
# ==============================================================================

class ProductionBatch(models.Model):
    production_order = models.ForeignKey(ProductionOrder, on_delete=models.PROTECT, related_name='batches', verbose_name="Sản xuất cho LotNo")
    furnace_name = models.CharField(max_length=50, verbose_name="Lò nấu")
    start_time = models.DateTimeField(default=timezone.now)
    end_time = models.DateTimeField(null=True, blank=True)
    status = models.CharField(max_length=20, choices=[('COOKING', 'Đang nấu'), ('DONE', 'Hoàn thành')], default='COOKING')
    
    si_final = models.FloatField(default=0, verbose_name="Si Final")
    fe_final = models.FloatField(default=0, verbose_name="Fe Final")
    cu_final = models.FloatField(default=0, verbose_name="Cu Final")
    
    history = HistoricalRecords()

    def __str__(self): return f"{self.production_order.lot_no} @ {self.furnace_name}"

class FurnaceLog(models.Model):
    batch = models.ForeignKey(ProductionBatch, related_name='logs', on_delete=models.CASCADE)
    timestamp = models.DateTimeField(default=timezone.now)
    action_type = models.CharField(max_length=20, choices=[('ADD', 'Nạp Liệu'), ('TEST', 'Test Mẫu')], default='ADD')
    
    issue_detail = models.ForeignKey(MaterialIssueDetail, on_delete=models.SET_NULL, null=True, blank=True)
    adhoc_material = models.ForeignKey(MaterialType, on_delete=models.SET_NULL, null=True, blank=True)
    adhoc_weight = models.FloatField(default=0)
    temperature = models.FloatField(default=0, verbose_name="Nhiệt độ")
    test_result_note = models.TextField(blank=True, verbose_name="KQ Test")


# ==============================================================================
# 5. THÀNH PHẨM & XUẤT HÀNG
# ==============================================================================

class WeighingSlip(models.Model):
    code = models.CharField(max_length=50, unique=True, verbose_name="Mã phiếu cân TP")
    production_order = models.ForeignKey(ProductionOrder, on_delete=models.PROTECT, verbose_name="Cân cho LotNo")
    date = models.DateTimeField(default=timezone.now)
    note = models.TextField(blank=True)

    def __str__(self): return f"{self.code} - {self.production_order.lot_no}"

class FinishedBundle(models.Model):
    weighing_slip = models.ForeignKey(WeighingSlip, related_name='bundles', on_delete=models.CASCADE)
    barcode = models.CharField(max_length=100, unique=True, verbose_name="Mã vạch")
    weight = models.DecimalField(max_digits=10, decimal_places=2, verbose_name="KL Tịnh")
    is_odd = models.BooleanField(default=False, verbose_name="Kiện lẻ")
    status = models.CharField(max_length=20, default='NEW', choices=[('NEW', 'Tồn kho'), ('SOLD', 'Đã bán')])
    batch = models.ForeignKey(ProductionBatch, on_delete=models.SET_NULL, null=True, blank=True)

class ScrapReturn(models.Model):
    weighing_slip = models.ForeignKey(WeighingSlip, related_name='scraps', on_delete=models.CASCADE)
    material_type = models.ForeignKey(MaterialType, on_delete=models.PROTECT)
    quantity = models.DecimalField(max_digits=10, decimal_places=2)

class DeliveryNote(models.Model):
    code = models.CharField(max_length=50, unique=True, verbose_name="Mã phiếu xuất")
    customer = models.ForeignKey(Customer, on_delete=models.PROTECT, verbose_name="Khách hàng")
    date = models.DateTimeField(default=timezone.now, verbose_name="Ngày xuất")
    note = models.TextField(blank=True)
    bundles = models.ManyToManyField(FinishedBundle, related_name='deliveries', verbose_name="Danh sách kiện")
    def __str__(self): return self.code

class RepackingSession(models.Model):
    code = models.CharField(max_length=50, unique=True, verbose_name="Mã phiếu xử lý")
    date = models.DateTimeField(default=timezone.now)
    note = models.TextField(blank=True)
    input_bundles = models.ManyToManyField(FinishedBundle, related_name='repacked_in', verbose_name="Kiện nguồn")
    def __str__(self): return self.code

==================================================
FILE: .\production\serializers.py
==================================================
from rest_framework import serializers
from .models import (
    ProductionOrder, ProductionOrderItem, MaterialIssueDetail,
    ProductionBatch, FurnaceLog, WeighingSlip, FinishedBundle,
    Customer, ProductStandard, AlloyType
)

# ==========================================================
# 1. CÁC SERIALIZERS PHỤ (Define trước để dùng sau)
# ==========================================================

class CustomerSerializer(serializers.ModelSerializer):
    class Meta:
        model = Customer
        fields = '__all__'

class AlloyTypeSerializer(serializers.ModelSerializer):
    class Meta:
        model = AlloyType
        fields = '__all__'

class ProductStandardSerializer(serializers.ModelSerializer):
    class Meta:
        model = ProductStandard
        fields = '__all__'

# ==========================================================
# 2. CHI TIẾT LỆNH (PHẢI ĐẶT TRÊN 'PRODUCTION ORDER')
# ==========================================================

class ProductionOrderItemSerializer(serializers.ModelSerializer):
    material_name = serializers.CharField(source='material_type.name', read_only=True)
    
    class Meta:
        model = ProductionOrderItem
        fields = ['id', 'material_type', 'material_name', 'quantity_required']

# ==========================================================
# 3. LỆNH SẢN XUẤT (GỌI ĐẾN CHI TIẾT LỆNH)
# ==========================================================

class ProductionOrderSerializer(serializers.ModelSerializer):
    customer_name = serializers.CharField(source='customer.name', read_only=True)
    product_type_name = serializers.CharField(source='product_type.name', read_only=True)
    
    # Lúc này Python đã biết ProductionOrderItemSerializer là ai rồi
    items = ProductionOrderItemSerializer(many=True, read_only=True)
    
    class Meta:
        model = ProductionOrder
        fields = ['id', 'lot_no', 'customer', 'customer_name', 
                  'product_type', 'product_type_name', 
                  'target_quantity', 'status', 'date_created', 'note', 'items']

# ==========================================================
# 4. KHO: PHIẾU SOẠN HÀNG
# ==========================================================

class MaterialIssueDetailSerializer(serializers.ModelSerializer):
    material_name = serializers.CharField(source='source_input.material_type.name', read_only=True)
    lot_input = serializers.CharField(source='source_input.supplier_lot_no', read_only=True)
    
    class Meta:
        model = MaterialIssueDetail
        fields = ['id', 'production_order', 'source_input', 'material_name', 'lot_input', 'real_weight', 'status']

# ==========================================================
# 5. LÒ: NHẬT KÝ & MẺ NẤU
# ==========================================================

class FurnaceLogSerializer(serializers.ModelSerializer):
    class Meta:
        model = FurnaceLog
        fields = '__all__'

class ProductionBatchSerializer(serializers.ModelSerializer):
    lot_no = serializers.CharField(source='production_order.lot_no', read_only=True)
    
    class Meta:
        model = ProductionBatch
        fields = ['id', 'production_order', 'lot_no', 'furnace_name', 
                  'start_time', 'end_time', 'status', 'si_final', 'fe_final', 'cu_final']

# ==========================================================
# 6. THÀNH PHẨM
# ==========================================================

class FinishedBundleSerializer(serializers.ModelSerializer):
    class Meta:
        model = FinishedBundle
        fields = '__all__'

class WeighingSlipSerializer(serializers.ModelSerializer):
    lot_no = serializers.CharField(source='production_order.lot_no', read_only=True)
    bundles = FinishedBundleSerializer(many=True, read_only=True)
    
    class Meta:
        model = WeighingSlip
        fields = ['id', 'code', 'production_order', 'lot_no', 'date', 'bundles']

==================================================
FILE: .\production\signals.py
==================================================
from django.db.models.signals import post_save, m2m_changed
from django.dispatch import receiver
# Dòng quan trọng: Phải import đủ DeliveryNote và FinishedBundle
from .models import FurnaceLog, ScrapReturn, DeliveryNote, FinishedBundle 
from warehouse_stock.models import InventoryItem
from warehouse_input.models import InputVoucherDetail
from decimal import Decimal

# 1. Nhập kho -> Cộng tồn
@receiver(post_save, sender=InputVoucherDetail)
def stock_in(sender, instance, created, **kwargs):
    if created:
        item, _ = InventoryItem.objects.get_or_create(material_type=instance.material_type)
        item.quantity_on_hand += instance.quantity
        item.save()

# 2. Nạp lò -> Trừ tồn
@receiver(post_save, sender=FurnaceLog)
def stock_out_furnace(sender, instance, created, **kwargs):
    if created and instance.action_type == 'ADD' and instance.material_type:
        item, _ = InventoryItem.objects.get_or_create(material_type=instance.material_type)
        item.quantity_on_hand -= Decimal(instance.quantity)
        item.save()

# 3. Hàng lỗi quay đầu -> Cộng tồn
@receiver(post_save, sender=ScrapReturn)
def stock_return_scrap(sender, instance, created, **kwargs):
    if created:
        item, _ = InventoryItem.objects.get_or_create(material_type=instance.material_type)
        item.quantity_on_hand += instance.quantity
        item.save()

# 4. XUẤT HÀNG -> ĐỔI TRẠNG THÁI KIỆN (Mới -> Đã bán)
@receiver(m2m_changed, sender=DeliveryNote.bundles.through)
def update_bundle_status_on_delivery(sender, instance, action, pk_set, **kwargs):
    if action == "post_add":
        # Khi add kiện vào phiếu xuất -> Đổi status thành SOLD
        FinishedBundle.objects.filter(pk__in=pk_set).update(status='SOLD')
    elif action == "post_remove":
        # Nếu lỡ tay xóa khỏi phiếu xuất -> Trả lại status NEW
        FinishedBundle.objects.filter(pk__in=pk_set).update(status='NEW')

==================================================
FILE: .\production\tests.py
==================================================
from django.test import TestCase

# Create your tests here.


==================================================
FILE: .\production\views.py
==================================================
# production/views.py
from rest_framework import viewsets
from django.shortcuts import render

# Import Models
from .models import (
    ProductionOrder, ProductionBatch, MaterialIssueDetail,
    WeighingSlip, FinishedBundle, Customer, ProductStandard
)

# Import Serializers
from .serializers import (
    ProductionOrderSerializer, ProductionBatchSerializer, MaterialIssueDetailSerializer,
    WeighingSlipSerializer, FinishedBundleSerializer, CustomerSerializer, ProductStandardSerializer
)

# 1. View cho Lệnh Sản Xuất
class ProductionOrderViewSet(viewsets.ModelViewSet):
    # Sắp xếp theo ngày tạo mới nhất
    queryset = ProductionOrder.objects.all().order_by('-date_created')
    serializer_class = ProductionOrderSerializer

# 2. View cho Mẻ Nấu (Lò)
class ProductionBatchViewSet(viewsets.ModelViewSet):
    # LƯU Ý QUAN TRỌNG: Sửa date_started -> start_time
    queryset = ProductionBatch.objects.all().order_by('-start_time')
    serializer_class = ProductionBatchSerializer

# 3. View cho Kho Soạn Hàng
class MaterialIssueDetailViewSet(viewsets.ModelViewSet):
    queryset = MaterialIssueDetail.objects.all().order_by('-created_at')
    serializer_class = MaterialIssueDetailSerializer

# 4. View cho Thành Phẩm
class WeighingSlipViewSet(viewsets.ModelViewSet):
    queryset = WeighingSlip.objects.all().order_by('-date')
    serializer_class = WeighingSlipSerializer

class FinishedBundleViewSet(viewsets.ModelViewSet):
    queryset = FinishedBundle.objects.all().order_by('-id')
    serializer_class = FinishedBundleSerializer

# 5. Danh mục
class CustomerViewSet(viewsets.ModelViewSet):
    queryset = Customer.objects.all()
    serializer_class = CustomerSerializer

class ProductStandardViewSet(viewsets.ModelViewSet):
    queryset = ProductStandard.objects.all()
    serializer_class = ProductStandardSerializer

# --- CÁC HÀM RENDER HTML CŨ (GIỮ NGUYÊN HOẶC CẬP NHẬT SAU) ---
def index(request):
    return render(request, 'production/index.html')

def weighing(request):
    return render(request, 'production/weighing.html')

==================================================
FILE: .\production\__init__.py
==================================================


==================================================
FILE: .\templates\base.html
==================================================
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenAlu ERP</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Tùy chỉnh nhỏ để giống Sapo hơn */
        .content-header { padding: 10px 0.5rem; }
        .card { box-shadow: 0 0 1px rgba(0,0,0,.125), 0 1px 3px rgba(0,0,0,.2); border-radius: 4px; }
        .sidebar-dark-primary { background-color: #0f1c3f !important; } /* Màu xanh đậm Sapo */
    </style>
</head>
<body class="hold-transition sidebar-mini layout-fixed">
<div class="wrapper">

    <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
            </li>
        </ul>
        <span class="ml-2 font-weight-bold text-uppercase">Hệ Thống Quản Lý Sản Xuất</span>
    </nav>

    {% include 'includes/sidebar.html' %}

    <div class="content-wrapper" style="background-color: #f4f6f9;">
        <div class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1 class="m-0">{% block title %}Tiêu đề trang{% endblock %}</h1>
                    </div>
                </div>
            </div>
        </div>
        
        <section class="content">
            <div class="container-fluid">
                {% block content %}
                {% endblock %}
            </div>
        </section>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
</body>
</html>

==================================================
FILE: .\templates\includes\sidebar.html
==================================================
<aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="/" class="brand-link text-center">
        <span class="brand-text font-weight-light font-weight-bold">GREENALU ERP</span>
    </a>

    <div class="sidebar">
        <nav class="mt-2">
            <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
                
                <li class="nav-item">
                    <a href="/" class="nav-link">
                        <i class="nav-icon fas fa-tachometer-alt"></i>
                        <p>Tổng quan</p>
                    </a>
                </li>

                <li class="nav-item">
                    <a href="/production/monthly-plan/" class="nav-link">
                        <i class="nav-icon fas fa-calendar-alt"></i>
                        <p>Kế hoạch sản xuất</p>
                    </a>
                </li>

                <li class="nav-item">
                    <a href="/stock/materials/" class="nav-link active"> <i class="nav-icon fas fa-cubes"></i>
                        <p>Tồn kho NVL</p>
                    </a>
                </li>

                <li class="nav-item">
                    <a href="/production/furnace-log/" class="nav-link">
                        <i class="nav-icon fas fa-fire"></i>
                        <p>Nhật ký lò nấu</p>
                    </a>
                </li>

                <li class="nav-item">
                    <a href="/stock/products/" class="nav-link">
                        <i class="nav-icon fas fa-box-open"></i>
                        <p>Tồn kho TP</p>
                    </a>
                </li>

            </ul>
        </nav>
    </div>
</aside>


==================================================
FILE: .\templates\production\index.html
==================================================
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Sản xuất Nhôm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-4">
    <h1 class="text-primary">Danh sách Kiện Thành Phẩm</h1>

    <table class="table table-bordered table-striped mt-3">
        <thead>
            <tr>
                <th>ID</th>
                <th>Lotno</th>
                <th>Khách Hàng</th>
                <th>Loại Nhôm</th>
                <th>Trọng Lượng (Kg)</th>
            </tr>
        </thead>
        <tbody id="bundle-table-body">
            </tbody>
    </table>

    <script>
        // 1. Hàm này sẽ chạy ngay khi trang web tải xong
        document.addEventListener('DOMContentLoaded', function() {
            taiDanhSachKien();
        });

        // 2. Hàm gọi API lấy dữ liệu
        function taiDanhSachKien() {
            // Gọi vào đường dẫn API mà chúng ta đã test nãy giờ
            fetch('/api/finished-bundles/')
                .then(response => response.json()) // Chuyển kết quả về dạng JSON
                .then(data => {
                    console.log("Dữ liệu nhận được:", data); // (Để debug xem có lỗi không)
                    
                    const tableBody = document.getElementById('bundle-table-body');
                    tableBody.innerHTML = ''; // Xóa sạch bảng cũ trước khi vẽ

                    // Duyệt qua từng dòng dữ liệu và vẽ lên bảng
                    data.forEach(item => {
                        const row = `
                            <tr>
                                <td>${item.id}</td>
                                <td>${item.batch_code || '-'}</td>
                                <td>${item.customer_name || '-'}</td>
                                <td>${item.alloy || '-'}</td>
                                <td class="text-end">${item.weight}</td>
                            </tr>
                        `;
                        tableBody.innerHTML += row; // Nhét dòng mới vào bảng
                    });
                })
                .catch(error => console.error('Lỗi khi tải dữ liệu:', error));
        }
    </script>
</body>
</html>

==================================================
FILE: .\templates\production\weighing.html
==================================================
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Nhập Phiếu Cân Tốc Độ Cao</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Tối ưu cho nhập liệu nhanh */
        .input-cell { border: 2px solid #0d6efd; background-color: #e7f1ff; font-weight: bold; }
        .input-cell:focus { background-color: #fff; box-shadow: 0 0 10px rgba(13, 110, 253, 0.5); }
        .table-input td { padding: 5px; vertical-align: middle; }
        .form-control-lg { border-radius: 0; }
        
        /* Ẩn bớt viền thừa để nhìn giống Excel */
        .table-bordered th, .table-bordered td { border: 1px solid #dee2e6; }
    </style>
</head>
<body class="bg-light">

<div class="container-fluid p-3">
    <div class="row mb-3 align-items-end">
        <div class="col-md-4">
            <label class="fw-bold">1. Chọn Lotno / Mẻ nấu:</label>
            <select id="select-batch" class="form-select" onchange="chonMeNau()"></select>
            <small class="text-primary fw-bold" id="batch-info">---</small>
        </div>
        <div class="col-md-4">
            <label class="fw-bold">2. Phiếu cân đang nhập:</label>
            <div class="input-group">
                <span class="input-group-text bg-warning fw-bold" id="current-slip-id">Chưa có phiếu</span>
                <button class="btn btn-primary" onclick="taoPhieuMoi()">+ Tạo Phiếu Mới (F2)</button>
            </div>
        </div>
        <div class="col-md-4 text-end">
             <h2 class="m-0 text-success">TOTAL: <span id="total-weight-display">0</span> kg</h2>
             <small>Số kiện: <span id="total-count-display">0</span></small>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <table class="table table-bordered table-hover mb-0 text-center align-middle">
                <thead class="table-dark">
                    <tr>
                        <th width="5%">#</th>
                        <th width="25%">TRỌNG LƯỢNG (KG)</th>
                        <th width="10%">Kiện lẻ?</th>
                        <th width="20%">Hàng NG (Kg)</th>
                        <th width="20%">Chân đế (Kg)</th>
                        <th width="20%">Trạng thái</th>
                    </tr>
                </thead>
                
                <tr class="table-primary">
                    <td><strong>MỚI</strong></td>
                    <td>
                        <input type="number" id="inp-weight" class="form-control form-control-lg input-cell text-center" 
                               placeholder="Nhập số cân..." step="0.1" onkeydown="handleEnter(event)">
                    </td>
                    <td>
                        <input type="checkbox" id="chk-odd" class="form-check-input" style="width: 30px; height: 30px;">
                    </td>
                    <td>
                        <input type="number" id="inp-ng" class="form-control input-cell text-center" placeholder="0" step="0.1">
                    </td>
                    <td>
                        <input type="number" id="inp-pallet" class="form-control input-cell text-center" placeholder="0" step="0.1" onkeydown="handleLastInput(event)">
                    </td>
                    <td>
                        <button onclick="luuKienHang()" class="btn btn-success fw-bold w-100">LƯU (↵)</button>
                    </td>
                </tr>

                <tbody id="table-body">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    let currentSlipId = null;

    document.addEventListener('DOMContentLoaded', function() {
        taiDanhSachMeNau();
        // Phím tắt F2 để tạo phiếu mới
        document.addEventListener('keydown', function(e) {
            if(e.key === "F2") { e.preventDefault(); taoPhieuMoi(); }
        });
    });

    // --- LOGIC XỬ LÝ BÀN PHÍM (CỰC QUAN TRỌNG) ---

    // 1. Tại ô Trọng Lượng: Bấm Enter -> Lưu ngay. Bấm Tab -> Sang ô Kiện lẻ
    function handleEnter(e) {
        if (e.key === "Enter") {
            e.preventDefault();
            luuKienHang(); // Lưu ngay lập tức
        }
    }

    // 2. Tại ô cuối cùng (Chân đế): Bấm Enter hoặc Tab -> Lưu
    function handleLastInput(e) {
        if (e.key === "Enter" || e.key === "Tab") {
            e.preventDefault();
            luuKienHang();
        }
    }

    // --- CÁC HÀM API GIỐNG CŨ (Đã tối ưu) ---

    function taiDanhSachMeNau() {
        fetch('/api/batches/')
            .then(res => res.json())
            .then(data => {
                const select = document.getElementById('select-batch');
                select.innerHTML = '<option value="">-- Chọn Mẻ --</option>';
                data.forEach(b => {
                    const opt = document.createElement('option');
                    opt.value = b.id;
                    opt.text = `${b.lot_no} (${b.customer_name})`;
                    opt.dataset.info = `${b.customer_name} - ${b.alloy_name}`;
                    select.appendChild(opt);
                });
            });
    }

    function chonMeNau() {
        const sel = document.getElementById('select-batch');
        const info = sel.options[sel.selectedIndex].dataset.info || "---";
        document.getElementById('batch-info').innerText = info;
        document.getElementById('inp-weight').focus(); // Chọn mẻ xong nhảy chuột vào ô nhập cân ngay
    }

    function taoPhieuMoi() {
    // 1. Kiểm tra xem đã chọn Mẻ chưa (Vì phiếu cần gắn với Mẻ)
    const batchId = document.getElementById('select-batch').value;
    if (!batchId) {
        alert("Vui lòng CHỌN LOTNO / MẺ NẤU trước khi tạo phiếu!");
        document.getElementById('select-batch').focus();
        return;
    }

    if(!confirm("Bạn muốn tạo phiếu cân mới cho mẻ này?")) return;

    // 2. Tự sinh mã phiếu (PC + Thời gian hiện tại để không trùng)
    // Ví dụ: PC-1735839201
    const autoCode = "PC-" + Date.now().toString().slice(-8); 

    const payload = {
        "date": new Date().toISOString().split('T')[0],
        "note": "Tạo từ web",
        "batch": batchId,   // <--- GỬI THÊM BATCH ID
        "code": autoCode    // <--- GỬI THÊM MÃ PHIẾU
    };

    // 3. Gọi API
    fetch('/api/weighing-slips/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(payload)
    })
    .then(async res => {
        if (!res.ok) {
            const text = await res.text();
            throw new Error(text);
        }
        return res.json();
    })
    .then(data => {
        // Thành công
        currentSlipId = data.id;
        document.getElementById('current-slip-id').innerText = "Phiếu: " + (data.code || data.id);
        
        // Xóa bảng cũ, reset tổng
        document.getElementById('table-body').innerHTML = ''; 
        updateTotal(0, 0);
        
        // Focus vào ô nhập liệu ngay
        document.getElementById('inp-weight').focus();
        
        // Thông báo nhỏ góc màn hình (Optional)
        console.log("Đã tạo phiếu:", data);
    })
    .catch(err => {
        console.error(err);
        alert("LỖI KHÔNG TẠO ĐƯỢC PHIẾU:\n" + err);
    });
    }

    function luuKienHang() {
        // 1. Lấy dữ liệu từ giao diện
        const weightInput = document.getElementById('inp-weight');
        const weight = weightInput.value;
        const isOdd = document.getElementById('chk-odd').checked;
        const ngWeight = document.getElementById('inp-ng').value || 0;
        const palletWeight = document.getElementById('inp-pallet').value || 0;
        
        // Lấy thông tin Mẻ để sinh mã vạch
        const batchSelect = document.getElementById('select-batch');
        const batchId = batchSelect.value;
        // Lấy chữ cái Lotno (ví dụ "01") để đặt tên cho đẹp
        const batchText = batchSelect.options[batchSelect.selectedIndex]?.text.split(' ')[0] || "BATCH";

        // 2. Validate (Kiểm tra)
        if (!currentSlipId) { 
            alert("⚠️ Bạn chưa tạo phiếu cân! Hãy bấm nút 'Tạo Phiếu Mới' hoặc ấn F2."); 
            return; 
        }
        if (!batchId) { 
            alert("⚠️ Vui lòng chọn Mẻ nấu trước!"); 
            batchSelect.focus(); 
            return; 
        }
        if (!weight) { 
            alert("⚠️ Hãy nhập trọng lượng!"); 
            weightInput.focus(); 
            return; 
        }

        // 3. TỰ ĐỘNG SINH MÃ VẠCH (Barcode)
        // Cấu trúc: LOTNO-THỜIGIAN (Ví dụ: 01-183025) để đảm bảo không trùng
        const timestamp = new Date().toTimeString().split(' ')[0].replace(/:/g, ''); // Lấy giờ phút giây: 183025
        const autoBarcode = `${batchText}-${timestamp}-${Math.floor(Math.random() * 100)}`;

        const payload = {
            "batch": batchId,
            "weighing_slip": currentSlipId,
            "weight": weight,
            "is_odd": isOdd,
            "ng_weight": ngWeight,
            "pallet_weight": palletWeight,
            "status": "NEW",
            "barcode": autoBarcode // <--- QUAN TRỌNG: Phải gửi cái này lên
        };

        // 4. Gửi lên Server
        fetch('/api/finished-bundles/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
            body: JSON.stringify(payload)
        })
        .then(async res => {
            // Nếu lỗi thì báo ngay
            if(!res.ok) {
                const errText = await res.text();
                throw new Error(errText); // Ném lỗi xuống phần catch
            }
            return res.json();
        })
        .then(item => {
            // 5. THÀNH CÔNG -> Cập nhật giao diện
            prependRow(item); // Thêm dòng vào bảng
            resetInputs();    // Xóa trắng ô nhập -> Tạo cảm giác "hiện ô mới"
            
            // Hiệu ứng nháy xanh để biết đã lưu
            weightInput.style.backgroundColor = "#d1e7dd";
            setTimeout(() => weightInput.style.backgroundColor = "#e7f1ff", 200);
        })
        .catch(err => {
            console.error(err);
            alert("❌ KHÔNG LƯU ĐƯỢC:\n" + err);
        });
    }

    function prependRow(item) {
        const tbody = document.getElementById('table-body');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.id}</td>
            <td class="fw-bold fs-5 text-primary">${item.weight}</td>
            <td>${item.is_odd ? '<span class="badge bg-warning text-dark">Lẻ</span>' : '-'}</td>
            <td>${item.ng_weight > 0 ? `<span class="text-danger">${item.ng_weight}</span>` : '-'}</td>
            <td>${item.pallet_weight > 0 ? item.pallet_weight : '-'}</td>
            <td><span class="badge bg-success">Đã lưu</span></td>
        `;
        tbody.insertBefore(row, tbody.firstChild); // Chèn lên đầu
        
        // Cập nhật số tổng (Logic cộng dồn tạm thời trên giao diện)
        let currentTotal = parseFloat(document.getElementById('total-weight-display').innerText);
        let currentCount = parseInt(document.getElementById('total-count-display').innerText);
        updateTotal(currentTotal + parseFloat(item.weight), currentCount + 1);
    }

    function resetInputs() {
        document.getElementById('inp-weight').value = '';
        document.getElementById('inp-ng').value = '';
        document.getElementById('inp-pallet').value = '';
        document.getElementById('chk-odd').checked = false;
        
        // QUAN TRỌNG: Đưa con trỏ chuột về lại ô nhập cân để nhập kiện tiếp theo ngay lập tức
        document.getElementById('inp-weight').focus();
    }

    function updateTotal(weight, count) {
        document.getElementById('total-weight-display').innerText = weight.toFixed(1);
        document.getElementById('total-count-display').innerText = count;
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) break;
            }
        }
        return document.cookie.split(';').find(c => c.trim().startsWith(name + '='))?.split('=')[1]
    }
</script>

</body>
</html>

==================================================
FILE: .\templates\warehouse_input\import.html
==================================================
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Phiếu Nhập Kho</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .input-sm { width: 100%; border: none; background: transparent; }
        .input-sm:focus { outline: 2px solid #0d6efd; background: white; }
    </style>
</head>
<body class="bg-light p-4">
    <div class="container bg-white p-4 shadow rounded">
        <h2 class="text-primary mb-4">📝 Tạo Phiếu Nhập Kho</h2>

        <div class="row mb-3">
            <div class="col-md-4">
                <label class="fw-bold">Nhà Cung Cấp:</label>
                <select id="supplier-select" class="form-select"></select>
            </div>
            <div class="col-md-4">
                <label class="fw-bold">Ngày Nhập:</label>
                <input type="date" id="date-input" class="form-control">
            </div>
            <div class="col-md-4">
                <label class="fw-bold">Ghi Chú:</label>
                <input type="text" id="note-input" class="form-control" placeholder="VD: Nhập nhôm đợt 1...">
            </div>
        </div>

        <table class="table table-bordered mt-4">
            <thead class="table-secondary text-center">
                <tr>
                    <th width="30%">Vật Tư / Loại Nhôm</th>
                    <th width="20%">Lot No (NCC)</th>
                    <th width="15%">Số Lượng (Kg)</th>
                    <th width="15%">Đơn Giá (VNĐ)</th>
                    <th width="10%">Thành Tiền</th>
                    <th width="5%">Xóa</th>
                </tr>
            </thead>
            <tbody id="details-body">
                </tbody>
        </table>

        <div class="d-flex justify-content-between">
            <button class="btn btn-secondary" onclick="themDong()">+ Thêm Dòng</button>
            <h4 class="text-danger">Tổng Tiền: <span id="total-amount">0</span></h4>
        </div>

        <hr>
        <button class="btn btn-primary btn-lg w-100" onclick="luuPhieuNhap()">💾 LƯU PHIẾU NHẬP</button>
    </div>

    <script>
        let materialOptions = ""; // Biến lưu danh sách vật tư để dùng lại khi thêm dòng

        document.addEventListener('DOMContentLoaded', function() {
            // 1. Tải danh sách NCC
            fetch('/api/suppliers/').then(r => r.json()).then(data => {
                const sel = document.getElementById('supplier-select');
                data.forEach(s => sel.innerHTML += `<option value="${s.id}">${s.name}</option>`);
            });

            // 2. Tải danh sách Vật tư
            fetch('/api/materials/').then(r => r.json()).then(data => {
                data.forEach(m => {
                    materialOptions += `<option value="${m.id}">${m.name} (${m.code})</option>`;
                });
                themDong(); // Thêm sẵn 1 dòng đầu tiên
            });

            // Set ngày hôm nay
            document.getElementById('date-input').valueAsDate = new Date();
        });

        function themDong() {
            const tbody = document.getElementById('details-body');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><select class="form-select material-select">${materialOptions}</select></td>
                <td><input type="text" class="form-control lot-input" placeholder="AL-202X..."></td>
                <td><input type="number" class="form-control qty-input" value="0" oninput="tinhTongTien()"></td>
                <td><input type="number" class="form-control price-input" value="0" oninput="tinhTongTien()"></td>
                <td class="text-end fw-bold row-total">0</td>
                <td class="text-center"><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); tinhTongTien()">X</button></td>
            `;
            tbody.appendChild(row);
        }

        function tinhTongTien() {
            let total = 0;
            document.querySelectorAll('#details-body tr').forEach(row => {
                const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
                const price = parseFloat(row.querySelector('.price-input').value) || 0;
                const rowTotal = qty * price;
                
                row.querySelector('.row-total').innerText = rowTotal.toLocaleString();
                total += rowTotal;
            });
            document.getElementById('total-amount').innerText = total.toLocaleString() + ' VNĐ';
        }

        function luuPhieuNhap() {
            // 1. Thu thập thông tin Header
            const supplierId = document.getElementById('supplier-select').value;
            const date = document.getElementById('date-input').value;
            const note = document.getElementById('note-input').value;
            
            // Tự sinh mã phiếu (PN + Timestamp)
            const autoCode = "PN-" + Date.now().toString().slice(-8);

            // 2. Thu thập danh sách chi tiết (Details)
            const details = [];
            const rows = document.querySelectorAll('#details-body tr');
            
            for (let row of rows) {
                const matId = row.querySelector('.material-select').value;
                const qty = parseFloat(row.querySelector('.qty-input').value);
                
                if (qty <= 0) continue; // Bỏ qua dòng số lượng 0

                details.push({
                    "material_type": matId,
                    "supplier_lot_no": row.querySelector('.lot-input').value,
                    "quantity": qty,
                    "unit_price": parseFloat(row.querySelector('.price-input').value) || 0
                });
            }

            if (details.length === 0) {
                alert("⚠️ Vui lòng nhập ít nhất 1 mặt hàng!");
                return;
            }

            // 3. Gửi JSON lên API
            const payload = {
                "code": autoCode,
                "date": date,
                "supplier": supplierId,
                "note": note,
                "details": details // <--- API Serializer đã viết sẵn logic xử lý cái list này
            };

            fetch('/api/input-vouchers/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken') // Hàm này lấy từ code cũ của bạn
                },
                body: JSON.stringify(payload)
            })
            .then(async res => {
                if (res.ok) {
                    alert("✅ Đã lưu phiếu nhập thành công!");
                    location.reload(); // Tải lại trang để nhập phiếu mới
                } else {
                    const err = await res.text();
                    alert("❌ Lỗi: " + err);
                }
            })
            .catch(err => alert("Lỗi kết nối: " + err));
        }

        // Hàm lấy Cookie (Copy từ file cũ của bạn)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>

==================================================
FILE: .\templates\warehouse_stock\inventory.html
==================================================
{% extends 'base.html' %} 

{% block title %}Tồn kho Nguyên Vật Liệu{% endblock %}

{% block content %}

    <div class="card shadow-sm">
        <div class="card-header">
            <h3 class="card-title">Danh sách vật tư</h3>
            <div class="card-tools">
                <button class="btn btn-primary btn-sm"><i class="fas fa-plus"></i> Nhập Mới</button>
            </div>
        </div>
        
        <div class="card-body p-0">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Mã VT</th>
                        <th>Tên Vật Tư</th>
                        <th>Số lượng</th>
                        <th>Đơn vị</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                    <tr>
                        <td>{{ item.material.code }}</td>
                        <td>{{ item.material.name }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>{{ item.material.unit }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="4" class="text-center">Chưa có dữ liệu</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endblock %}

    <script>
        let rawData = []; // Lưu dữ liệu gốc để tìm kiếm

        document.addEventListener('DOMContentLoaded', function() {
            taiDuLieu();
        });

        function taiDuLieu() {
            fetch('/api/inventory/')
                .then(res => res.json())
                .then(data => {
                    rawData = data;
                    renderGrid(data);
                })
                .catch(err => console.error("Lỗi tải dữ liệu:", err));
        }

        function renderGrid(data) {
            const container = document.getElementById('inventory-grid');
            container.innerHTML = '';

            if(data.length === 0) {
                container.innerHTML = `<div class="col-12 text-center text-muted">Chưa có dữ liệu tồn kho.</div>`;
                return;
            }

            data.forEach(item => {
                // Tính toán phần trăm kế hoạch (Để vẽ thanh tiến độ)
                // Nếu chưa có kế hoạch (0) thì mặc định là 0%
                const plan = item.planned_quantity || 1; // Tránh chia cho 0
                const percent = Math.min(((item.quantity_on_hand / plan) * 100), 100);
                
                // Logic màu sắc thanh tiến độ: <20% báo đỏ, >80% báo xanh
                let progressColor = 'bg-primary';
                if(percent < 20) progressColor = 'bg-danger';
                if(percent > 100) progressColor = 'bg-success';

                const cardHtml = `
                <div class="col-md-6 col-lg-4 col-xl-3">
                    <div class="card card-inventory border-0 shadow-sm h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h5 class="card-title fw-bold text-dark mb-0">${item.material_name}</h5>
                                    <small class="text-muted">${item.material_code}</small>
                                </div>
                                <span class="badge bg-secondary">${item.unit}</span>
                            </div>

                            <div class="row text-center my-3">
                                <div class="col-4 border-end">
                                    <small class="text-muted d-block">Thực Tế</small>
                                    <span class="fs-5 fw-bold text-primary">${formatNumber(item.quantity_on_hand)}</span>
                                </div>
                                <div class="col-4 border-end">
                                    <small class="text-muted d-block">Kế Hoạch</small>
                                    <span class="fs-5 fw-bold text-dark">${formatNumber(item.planned_quantity)}</span>
                                </div>
                                <div class="col-4">
                                    <small class="text-muted d-block">Đang Chờ</small>
                                    <span class="fs-5 text-pending">${formatNumber(item.pending_quantity)}</span>
                                </div>
                            </div>

                            <div class="mt-2">
                                <div class="d-flex justify-content-between" style="font-size: 0.8rem;">
                                    <span>Tiến độ tồn kho</span>
                                    <span>${percent.toFixed(0)}% Plan</span>
                                </div>
                                <div class="progress progress-micro">
                                    <div class="progress-bar ${progressColor}" style="width: ${percent}%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-white border-0 pt-0">
                            <small class="text-muted fst-italic">
                                Cập nhật: ${new Date(item.last_updated).toLocaleString('vi-VN')}
                            </small>
                        </div>
                    </div>
                </div>
                `;
                container.innerHTML += cardHtml;
            });
        }

        function formatNumber(num) {
            return parseFloat(num).toLocaleString('vi-VN', {maximumFractionDigits: 0});
        }

        function filterData() {
            const term = document.getElementById('search-box').value.toLowerCase();
            const filtered = rawData.filter(item => 
                item.material_name.toLowerCase().includes(term) || 
                item.material_code.toLowerCase().includes(term)
            );
            renderGrid(filtered);
        }
    </script>
</body>
</html>

==================================================
FILE: .\warehouse_input\admin.py
==================================================
from django.contrib import admin
from .models import MaterialType, Supplier, InputVoucher, InputVoucherDetail

class InputVoucherDetailInline(admin.TabularInline):
    model = InputVoucherDetail
    extra = 1

class InputVoucherAdmin(admin.ModelAdmin):
    inlines = [InputVoucherDetailInline]
    list_display = ('code', 'date', 'supplier')

admin.site.register(MaterialType)
admin.site.register(Supplier)
admin.site.register(InputVoucher, InputVoucherAdmin)

==================================================
FILE: .\warehouse_input\apps.py
==================================================
from django.apps import AppConfig


class WarehouseInputConfig(AppConfig):
    name = 'warehouse_input'


==================================================
FILE: .\warehouse_input\models.py
==================================================
from django.db import models
from django.utils import timezone

# 1. Loại vật tư (Phải đứng đầu)
class MaterialType(models.Model):
    name = models.CharField(max_length=100, verbose_name="Tên loại vật tư")
    code = models.CharField(max_length=20, unique=True, verbose_name="Mã VT")
    unit = models.CharField(max_length=20, default="kg", verbose_name="Đơn vị")
    description = models.TextField(blank=True, verbose_name="Mô tả")

    def __str__(self): return f"{self.name} ({self.code})"

# 2. Nhà cung cấp
class Supplier(models.Model):
    name = models.CharField(max_length=200, verbose_name="Nhà cung cấp")
    phone = models.CharField(max_length=20, blank=True, verbose_name="SĐT")
    address = models.TextField(blank=True, verbose_name="Địa chỉ")
    
    def __str__(self): return self.name

# 3. Phiếu nhập (Header)
class InputVoucher(models.Model):
    code = models.CharField(max_length=50, unique=True, verbose_name="Mã phiếu nhập")
    date = models.DateTimeField(default=timezone.now, verbose_name="Ngày nhập")
    supplier = models.ForeignKey(Supplier, on_delete=models.PROTECT, verbose_name="Nhà cung cấp")
    note = models.TextField(blank=True, verbose_name="Ghi chú")
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self): return f"{self.code} - {self.supplier.name}"

    @property
    def total_amount(self):
        # Tính tổng tiền (Cần InputVoucherDetail đã được định nghĩa hoặc dùng related name)
        # Lưu ý: Hàm này gọi lúc chạy (runtime) nên đặt ở đây vẫn OK
        return sum(item.total_price for item in self.details.all())

# 4. Chi tiết phiếu nhập (Detail)
class InputVoucherDetail(models.Model):
    voucher = models.ForeignKey(InputVoucher, related_name='details', on_delete=models.CASCADE)
    material_type = models.ForeignKey(MaterialType, on_delete=models.PROTECT, verbose_name="Loại hàng")
    
    supplier_lot_no = models.CharField(max_length=50, blank=True, verbose_name="Lot NCC") 
    quantity = models.DecimalField(max_digits=12, decimal_places=2, verbose_name="Khối lượng (kg)")
    unit_price = models.DecimalField(max_digits=14, decimal_places=2, default=0, verbose_name="Đơn giá (VND)") 
    
    # QC Input
    si_test = models.FloatField(default=0, verbose_name="Si (%)")
    fe_test = models.FloatField(default=0, verbose_name="Fe (%)")
    cu_test = models.FloatField(default=0, verbose_name="Cu (%)")

    def __str__(self): return f"{self.material_type.code} - {self.quantity}kg"

    @property
    def total_price(self):
        return self.quantity * self.unit_price

==================================================
FILE: .\warehouse_input\serializers.py
==================================================
from rest_framework import serializers
from .models import MaterialType, Supplier, InputVoucher, InputVoucherDetail

# 1. Serializer cho Vật tư & NCC (Đơn giản)
class MaterialTypeSerializer(serializers.ModelSerializer):
    class Meta:
        model = MaterialType
        fields = '__all__'

class SupplierSerializer(serializers.ModelSerializer):
    class Meta:
        model = Supplier
        fields = '__all__'

# 2. Serializer cho Chi tiết phiếu nhập
class InputVoucherDetailSerializer(serializers.ModelSerializer):
    # Hiển thị thêm tên vật tư để dễ nhìn trên Frontend
    material_name = serializers.CharField(source='material_type.name', read_only=True)
    material_code = serializers.CharField(source='material_type.code', read_only=True)
    
    total_price = serializers.DecimalField(max_digits=14, decimal_places=2, read_only=True)

    class Meta:
        model = InputVoucherDetail
        fields = ['id', 'material_type', 'material_name', 'material_code', 
                  'supplier_lot_no', 'quantity', 'unit_price', 'total_price',
                  'si_test', 'fe_test', 'cu_test']

# 3. Serializer cho Phiếu nhập (QUAN TRỌNG)
class InputVoucherSerializer(serializers.ModelSerializer):
    supplier_name = serializers.CharField(source='supplier.name', read_only=True)
    details = InputVoucherDetailSerializer(many=True) # Cho phép gửi kèm danh sách chi tiết
    total_amount = serializers.DecimalField(max_digits=14, decimal_places=2, read_only=True)

    class Meta:
        model = InputVoucher
        fields = ['id', 'code', 'date', 'supplier', 'supplier_name', 'note', 'details', 'total_amount']

    # Hàm này xử lý việc lưu cùng lúc Phiếu + Chi tiết
    def create(self, validated_data):
        details_data = validated_data.pop('details') # Tách phần chi tiết ra
        voucher = InputVoucher.objects.create(**validated_data) # Tạo phiếu trước
        
        # Sau đó tạo từng dòng chi tiết gắn vào phiếu
        for detail_data in details_data:
            InputVoucherDetail.objects.create(voucher=voucher, **detail_data)
        
        return voucher

==================================================
FILE: .\warehouse_input\tests.py
==================================================
from django.test import TestCase

# Create your tests here.


==================================================
FILE: .\warehouse_input\views.py
==================================================
from rest_framework import viewsets
from .models import MaterialType, Supplier, InputVoucher
from .serializers import MaterialTypeSerializer, SupplierSerializer, InputVoucherSerializer
from django.shortcuts import render

class MaterialTypeViewSet(viewsets.ModelViewSet):
    queryset = MaterialType.objects.all()
    serializer_class = MaterialTypeSerializer

class SupplierViewSet(viewsets.ModelViewSet):
    queryset = Supplier.objects.all()
    serializer_class = SupplierSerializer

class InputVoucherViewSet(viewsets.ModelViewSet):
    # prefetch_related('details') giúp lấy luôn chi tiết, tránh query DB quá nhiều lần
    queryset = InputVoucher.objects.all().prefetch_related('details').order_by('-date')
    serializer_class = InputVoucherSerializer
def import_page(request):
    """Trả về giao diện phiếu nhập kho"""
    return render(request, 'warehouse_input/import.html')

==================================================
FILE: .\warehouse_input\__init__.py
==================================================


==================================================
FILE: .\warehouse_stock\admin.py
==================================================
from django.contrib import admin
from .models import InventoryItem, StockAdjustment

class InventoryItemAdmin(admin.ModelAdmin):
    list_display = ('material_type', 'quantity_on_hand', 'last_updated')
    list_filter = ('material_type',)

class StockAdjustmentAdmin(admin.ModelAdmin):
    list_display = ('code', 'material_type', 'adjustment_quantity', 'date')

admin.site.register(InventoryItem, InventoryItemAdmin)
admin.site.register(StockAdjustment, StockAdjustmentAdmin)

==================================================
FILE: .\warehouse_stock\apps.py
==================================================
from django.apps import AppConfig


class WarehouseStockConfig(AppConfig):
    name = 'warehouse_stock'
def ready(self):
        import production.signals

==================================================
FILE: .\warehouse_stock\models.py
==================================================
from django.db import models
from django.utils import timezone
# Nếu lỗi "No module named simple_history", hãy chạy: pip install django-simple-history
# Hoặc comment 2 dòng dưới đây lại:
from simple_history.models import HistoricalRecords 

class InventoryItem(models.Model):
    # Dùng chuỗi tham chiếu 'warehouse_input.MaterialType' để tránh lỗi vòng lặp (Circular Import)
    material_type = models.ForeignKey('warehouse_input.MaterialType', on_delete=models.CASCADE, verbose_name="Loại vật tư")
    quantity_on_hand = models.DecimalField(max_digits=12, decimal_places=2, default=0, verbose_name="Tồn kho thực tế")
    min_stock_level = models.DecimalField(max_digits=12, decimal_places=2, default=0, verbose_name="Mức an toàn")
    
    last_updated = models.DateTimeField(auto_now=True)
    
    # Nếu chưa cài simple_history thì comment dòng này lại:
    history = HistoricalRecords() 

    def __str__(self):
        return f"{self.material_type.name}: {self.quantity_on_hand}"

class StockAdjustment(models.Model):
    code = models.CharField(max_length=50, unique=True, verbose_name="Mã phiếu kiểm kê")
    date = models.DateTimeField(default=timezone.now)
    material_type = models.ForeignKey('warehouse_input.MaterialType', on_delete=models.PROTECT, verbose_name="Vật tư")
    
    adjustment_quantity = models.DecimalField(max_digits=12, decimal_places=2, verbose_name="Lượng điều chỉnh (+/-)")
    reason = models.TextField(verbose_name="Lý do chênh lệch")
    created_at = models.DateTimeField(auto_now_add=True)

    def __str__(self): return f"{self.code} ({self.adjustment_quantity}kg)"

==================================================
FILE: .\warehouse_stock\serializers.py
==================================================
# warehouse_stock/serializers.py
from rest_framework import serializers
from django.utils import timezone
from django.db.models import Sum
from .models import InventoryItem, StockAdjustment

# Import Model từ App khác để tính toán (Import bên trong method để tránh lỗi vòng lặp)
# Lưu ý: Chúng ta sẽ import dynamic bên dưới

class InventoryItemSerializer(serializers.ModelSerializer):
    material_name = serializers.CharField(source='material_type.name', read_only=True)
    material_code = serializers.CharField(source='material_type.code', read_only=True)
    unit = serializers.CharField(source='material_type.unit', read_only=True)
    
    # 2 trường tính toán mới
    planned_quantity = serializers.SerializerMethodField()
    pending_quantity = serializers.SerializerMethodField()

    class Meta:
        model = InventoryItem
        fields = ['id', 'material_type', 'material_name', 'material_code', 'quantity_on_hand', 'unit', 'last_updated', 'planned_quantity', 'pending_quantity']

    def get_planned_quantity(self, obj):
        """Lấy kế hoạch của tháng hiện tại"""
        from production.models import MonthlyPlan # Import ở đây để tránh Circular Import
        
        current_month = timezone.now().strftime('%Y-%m') # VD: "2024-01"
        plan = MonthlyPlan.objects.filter(material_type=obj.material_type, month=current_month).first()
        return plan.planned_quantity if plan else 0

    def get_pending_quantity(self, obj):
        """Tính tổng lượng hàng đã soạn (WAITING) đang nằm ở cửa lò"""
        from production.models import MaterialIssueDetail # Import ở đây
        
        # Lọc các phiếu cân trạng thái WAITING của loại vật tư này
        pending = MaterialIssueDetail.objects.filter(
            source_input__material_type=obj.material_type, 
            status='WAITING'
        ).aggregate(Sum('real_weight'))
        
        return pending['real_weight__sum'] or 0

class StockAdjustmentSerializer(serializers.ModelSerializer):
    material_name = serializers.CharField(source='material_type.name', read_only=True)
    class Meta:
        model = StockAdjustment
        fields = '__all__'

==================================================
FILE: .\warehouse_stock\signals.py
==================================================
from django.db.models.signals import post_save
from django.dispatch import receiver
from .models import StockAdjustment, InventoryItem

@receiver(post_save, sender=StockAdjustment)
def adjust_inventory(sender, instance, created, **kwargs):
    if created:
        item, _ = InventoryItem.objects.get_or_create(material_type=instance.material_type)
        item.quantity_on_hand += instance.adjustment_quantity
        item.save()

==================================================
FILE: .\warehouse_stock\tests.py
==================================================
from django.test import TestCase

# Create your tests here.


==================================================
FILE: .\warehouse_stock\views.py
==================================================
from django.shortcuts import render
from rest_framework import viewsets
from rest_framework.decorators import action
from rest_framework.response import Response
from django.db.models import F

# Import các Models liên quan
from .models import InventoryItem, StockAdjustment
from .serializers import InventoryItemSerializer, StockAdjustmentSerializer
from warehouse_input.models import InputVoucherDetail
from production.models import FurnaceLog

class InventoryItemViewSet(viewsets.ReadOnlyModelViewSet): 
    queryset = InventoryItem.objects.all().order_by('material_type__name')
    serializer_class = InventoryItemSerializer

    # --- TÍNH NĂNG MỚI: LẤY LỊCH SỬ GIAO DỊCH ---
    @action(detail=True, methods=['get'])
    def history(self, request, pk=None):
        """
        API này trả về lịch sử biến động của 1 vật tư.
        Logic: Gom tất cả Nhập + Xuất + Điều chỉnh -> Sắp xếp theo thời gian -> Tính tồn kho lũy kế.
        """
        inventory_item = self.get_object()
        material = inventory_item.material_type
        
        transactions = []

        # 1. Lấy lịch sử NHẬP KHO (+)
        inputs = InputVoucherDetail.objects.filter(material_type=material).select_related('voucher')
        for item in inputs:
            transactions.append({
                "date": item.voucher.date,
                "type": "NHAP",
                "quantity": item.quantity, # Số dương
                "reason": f"Phiếu nhập: {item.voucher.code}",
                "ref_id": item.voucher.id
            })

        # 2. Lấy lịch sử XUẤT SẢN XUẤT (NẤU LÒ) (-)
        outputs = FurnaceLog.objects.filter(material_type=material, action_type='ADD')
        for item in outputs:
            transactions.append({
                "date": item.timestamp,
                "type": "XUAT",
                "quantity": -item.quantity, # Số âm (trừ đi)
                "reason": f"Cấp lò: {item.batch.furnace_name} (Lot: {item.batch.lot_no})",
                "ref_id": item.batch.id
            })

        # 3. Lấy lịch sử KIỂM KÊ / ĐIỀU CHỈNH (+/-)
        adjusts = StockAdjustment.objects.filter(material_type=material)
        for item in adjusts:
            transactions.append({
                "date": item.date,
                "type": "DIEU_CHINH",
                "quantity": item.adjustment_quantity, # Có thể âm hoặc dương
                "reason": f"Kiểm kê: {item.code} ({item.reason})",
                "ref_id": item.id
            })

        # 4. Sắp xếp theo ngày tăng dần
        transactions.sort(key=lambda x: x['date'])

        # 5. Tính tồn kho lũy kế (Running Balance)
        running_balance = 0
        results = []
        for t in transactions:
            running_balance += float(t['quantity'])
            results.append({
                "date": t['date'],
                "reason": t['reason'],
                "change": t['quantity'],
                "balance": running_balance # Tồn cuối sau giao dịch này
            })

        # Đảo ngược lại để ngày mới nhất lên đầu cho dễ xem
        results.reverse()
        
        return Response(results)

class StockAdjustmentViewSet(viewsets.ModelViewSet):
    queryset = StockAdjustment.objects.all().order_by('-date')
    serializer_class = StockAdjustmentSerializer

def inventory_page(request):
    """Trả về giao diện báo cáo tồn kho"""
    return render(request, 'warehouse_stock\inventory.html')

==================================================
FILE: .\warehouse_stock\__init__.py
==================================================

